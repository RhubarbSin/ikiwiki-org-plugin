#!/bin/bash

inputfile=$(tempfile)
outputfile=$(tempfile)

watch() {
#    tail --follow=name $outputfile > /dev/stderr &
    tail --follow=name $outputfile 2> /dev/null
}

cleanup() {
    rm $inputfile
    rm $outputfile
}

trap cleanup SIGHUP SIGINT EXIT

check-emacs() {
    # check if the daemon is running with a simple math problem
    emacsclient -s "org-ikiwiki-compiler" --eval "(+ 1 1)"
    # if it isn't then start a new one
    if [ $? -ne 0 ]; then
	emacs --daemon --eval "(progn (require 'ikiwiki-org-plugin) (setq server-name \"org-ikiwiki-compiler\") (server-start))"
    fi
}

IFS=
watch &
check-emacs
emacsclient -s "org-ikiwiki-compiler" --eval "(org-ikiwiki-compile \"$inputfile\" \"$outputfile\")" &
while read -r line; do
    echo -E "$line" >> $inputfile
#    echo -E "$line" > /dev/stderr
done
